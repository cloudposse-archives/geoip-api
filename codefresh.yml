version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    working_directory: ./
    dockerfile: Dockerfile
    tag: "${{CF_BRANCH_TAG_NORMALIZED}}"
    metadata:
      set:
        - commit_url: '${{CF_COMMIT_URL}}'
        - note: '${{CF_COMMIT_MESSAGE}}'
        - revision: '${{CF_REVISION}}'
  DockerPush:
    type: push
    title: Push Docker image
    description: '${{CF_COMMIT_MESSAGE}}'
    candidate: "${{BuildingDockerImage}}"
    tag: "${{CF_BRANCH_TAG_NORMALIZED}}"
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    registry: dockerhub
    fail_fast: false

  ReleaseOnK8S:
    image: codefresh/plugin-helm:2.7.2
    environment:
      - CHART_NAME=${{CF_REPO_NAME}}
      - RELEASE_NAME=${{CF_BRANCH_TAG_NORMALIZED}}
      - KUBE_CONTEXT=goruha
      - NAMESPACE=codefresh
      - CHART_VERSION=0.1.0
      - CHART_REPO_URL=https://charts.cloudposse.com/incubator
      - WAIT=true
      - TIMEOUT=1200
